<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Job - Trial Shift</title>
  <link rel="stylesheet" href="/css/job-post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Post a New Job</h1>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobFormCard">
          <div class="card-content">
            <form action="/api/jobs" method="POST" class="col s12" id="jobForm">
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="title" name="title" required>
                  <label for="title">Job Title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <select id="category" name="category" required>
                    <option value="" disabled selected> Choose a category </option>
                    <option value="kitchenhand" data-count="0"> Kitchen Hand <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                    <option value="accounting" data-count="0"> Accounting <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                    <option value="delivery" data-count="0"> Delivery <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                    <option value="waiter" data-count="0"> Waiter <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                    <option value="barista" data-count="0"> Barista <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                    <option value="pickpacker" data-count="0"> Pick Packer <span class="badge" data-badge-caption=""> 0 jobs </span></option>
                  </select>
                  <label for="category">Category</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="location" name="location" required>
                  <label for="location">Location</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="shiftDetails" name="shiftDetails" class="materialize-textarea" required></textarea>
                  <label for="shiftDetails">Shift Details</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <button type="submit" class="btn">Submit Job</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="successMessage" style="display: none; text-align: center; color: green;"></div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 center-align">
        <a href="/dashboard.html">Back to Dashboard</a>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Fetch and update category counts
    function updateCategoryCounts() {
      fetch('/api/categories/counts')
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          console.log('Fetched category counts:', data);
          const select = document.getElementById('category');
          data.forEach(category => {
            const option = select.querySelector(`option[value="${category.name}"]`);
            if (option) {
              const badge = option.querySelector('.badge');
              if (badge) {
                badge.textContent = ''; // Clear existing content
                option.dataset.count = category.count;
                badge.setAttribute('data-badge-caption', category.count > 0 ? `${category.count} jobs` : '');
                console.log(`Updated ${category.name} to count: ${category.count}`);
              }
            }
          });
          M.FormSelect.init(select); // Reinitialize Materialize select
        })
        .catch(error => console.error('Error fetching category counts:', error));
    }
    updateCategoryCounts(); // Initial load

    // Handle form submission
    const form = document.querySelector('#jobForm');
    const card = document.querySelector('#jobFormCard');
    const successMsg = document.querySelector('#successMessage');
    if (!form || !card || !successMsg) console.error('Required elements not found');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const data = Object.fromEntries(formData);
      console.log('Form data:', data);
      console.log('Sending fetch request to /api/jobs...');
      fetch('/api/jobs', {
        method: 'POST',
        body: new URLSearchParams(data),
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      })
        .then(response => {
          console.log('Fetch response status:', response.status);
          console.log('Response headers:', response.headers);
          if (response.status !== 201) {
            throw new Error(`Expected 201, got ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Success:', data);
          card.style.display = 'none';
          successMsg.style.display = 'block';
          successMsg.textContent = 'Job created successfully!';
          setTimeout(() => {
            card.style.display = 'block';
            successMsg.style.display = 'none';
            form.reset();
            M.updateTextFields();
            updateCategoryCounts(); // Refresh counts after submission
          }, 3000);
        })
        .catch(error => console.error('Fetch error:', error));
      this.querySelector('button[type="submit"]').disabled = true;
      setTimeout(() => {
        this.querySelector('button[type="submit"]').disabled = false;
      }, 2000);
    });
  });
</script>
</body>
</html> -->



<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Job - Trial Shift</title>
  <link rel="stylesheet" href="/css/job-post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Post a New Job</h1>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobFormCard">
          <div class="card-content">
            <form action="/api/jobs" method="POST" class="col s12" id="jobForm">
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="title" name="title" required>
                  <label for="title">Job Title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <select id="category" name="category" required>
                    <option value="" disabled selected>Choose a category</option>
                    <option value="kitchenhand" data-count="0">Kitchen Hand <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="cleaning" data-count="0">Cleaning <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="delivery" data-count="0">Delivery <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="waiter" data-count="0">Waiter <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="barista" data-count="0">Barista <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="pickpacker" data-count="0">Pick Packer <span class="badge" data-badge-caption="">0 jobs</span></option>
                  </select>
                  <label for="category">Category</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="location" name="location" required>
                  <label for="location">Location</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="shiftDetails" name="shiftDetails" class="materialize-textarea" required></textarea>
                  <label for="shiftDetails">Shift Details</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <button type="submit" class="btn">Submit Job</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="successMessage" style="display: none; text-align: center; color: green;"></div>
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobManageCard">
          <div class="card-content">
            <h4>Your Posted Jobs</h4>
            <ul class="collection" id="jobList">
              <li class="collection-item">Loading jobs...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 center-align">
        <a href="/dashboard.html">Back to Dashboard</a>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and update category counts
      function updateCategoryCounts() {
        fetch('/api/categories/counts')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            console.log('Fetched category counts:', data);
            const select = document.getElementById('category');
            data.forEach(category => {
              const option = select.querySelector(`option[value="${category.name}"]`);
              if (option) {
                const badge = option.querySelector('.badge');
                if (badge) {
                  badge.textContent = ''; // Clear existing content
                  option.dataset.count = category.count;
                  badge.setAttribute('data-badge-caption', category.count > 0 ? `${category.count} jobs` : '');
                  console.log(`Updated ${category.name} to count: ${category.count}`);
                }
              }
            });
            M.FormSelect.init(select); // Reinitialize Materialize select
          })
          .catch(error => console.error('Error fetching category counts:', error));
      }
      updateCategoryCounts(); // Initial load

      // Fetch and display employer jobs
      function loadEmployerJobs() {
        fetch('/api/jobs/employer')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(jobs => {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = ''; // Clear loading message
            if (jobs.length === 0 || (jobs.message && jobs.message.includes('No jobs'))) {
              jobList.innerHTML = '<li class="collection-item">No jobs posted.</li>';
            } else {
              jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.innerHTML = `
                  <div class="job-details">
                    ${job.title} - ${job.location} (${job.shiftDetails})
                  </div>
                  <div class="job-actions">
                    <a href="/job-edit?id=${job._id}" class="btn-small">Edit</a>
                    <button class="btn-small red delete-job" data-id="${job._id}">Delete</button>
                  </div>
                `;
                jobList.appendChild(li);
              });
              // Add delete event listeners
              document.querySelectorAll('.delete-job').forEach(button => {
                button.addEventListener('click', function() {
                  const jobId = this.getAttribute('data-id');
                  if (confirm('Are you sure you want to delete this job?')) {
                    fetch(`/api/jobs/${jobId}`, {
                      method: 'DELETE'
                    })
                      .then(response => {
                        if (response.ok) {
                          loadEmployerJobs(); // Reload jobs after deletion
                          M.toast({ html: 'Job deleted successfully!' });
                        } else {
                          throw new Error('Failed to delete job');
                        }
                      })
                      .catch(error => console.error('Error deleting job:', error));
                  }
                });
              });
            }
          })
          .catch(error => console.error('Error fetching jobs:', error));
      }
      loadEmployerJobs(); // Initial load

      // Handle form submission
      const form = document.querySelector('#jobForm');
      const card = document.querySelector('#jobFormCard');
      const successMsg = document.querySelector('#successMessage');
      if (!form || !card || !successMsg) console.error('Required elements not found');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Form data:', data);
        console.log('Sending fetch request to /api/jobs...');
        fetch('/api/jobs', {
          method: 'POST',
          body: new URLSearchParams(data),
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        })
          .then(response => {
            console.log('Fetch response status:', response.status);
            console.log('Response headers:', response.headers);
            if (response.status !== 201) {
              throw new Error(`Expected 201, got ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Success:', data);
            card.style.display = 'none';
            successMsg.style.display = 'block';
            successMsg.textContent = 'Job created successfully!';
            setTimeout(() => {
              card.style.display = 'block';
              successMsg.style.display = 'none';
              form.reset();
              M.updateTextFields();
              updateCategoryCounts(); // Refresh counts after submission
              loadEmployerJobs(); // Refresh job list after submission
            }, 3000);
          })
          .catch(error => console.error('Fetch error:', error));
        this.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => {
          this.querySelector('button[type="submit"]').disabled = false;
        }, 2000);
      });
    });
  </script>
</body>
</html> -->


<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Job - Trial Shift</title>
  <link rel="stylesheet" href="/css/job-post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Post a New Job</h1>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobFormCard">
          <div class="card-content">
            <form action="/api/jobs" method="POST" class="col s12" id="jobForm">
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="title" name="title" required>
                  <label for="title">Job Title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <select id="category" name="category" required>
                    <option value="" disabled selected>Choose a category</option>
                    <option value="kitchenhand" data-count="0">Kitchen Hand <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="cleaning" data-count="0">Cleaning <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="delivery" data-count="0">Delivery <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="waiter" data-count="0">Waiter <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="barista" data-count="0">Barista <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="pickpacker" data-count="0">Pick Packer <span class="badge" data-badge-caption="">0 jobs</span></option>
                  </select>
                  <label for="category">Category</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="location" name="location" required>
                  <label for="location">Location</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="shiftDetails" name="shiftDetails" class="materialize-textarea" required></textarea>
                  <label for="shiftDetails">Shift Details</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <button type="submit" class="btn">Submit Job</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="successMessage" style="display: none; text-align: center; color: green;"></div>
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobManageCard">
          <div class="card-content">
            <h4>Your Posted Jobs</h4>
            <ul class="collection" id="jobList">
              <li class="collection-item">Loading jobs...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 center-align">
        <a href="/dashboard.html">Back to Dashboard</a>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and update category counts
      function updateCategoryCounts() {
        fetch('/api/categories/counts')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            console.log('Fetched category counts:', data);
            const select = document.getElementById('category');
            data.forEach(category => {
              const option = select.querySelector(`option[value="${category.name}"]`);
              if (option) {
                const badge = option.querySelector('.badge');
                if (badge) {
                  badge.textContent = ''; // Clear existing content
                  option.dataset.count = category.count;
                  badge.setAttribute('data-badge-caption', category.count > 0 ? `${category.count} jobs` : '');
                  console.log(`Updated ${category.name} to count: ${category.count}`);
                }
              }
            });
            M.FormSelect.init(select); // Reinitialize Materialize select
          })
          .catch(error => console.error('Error fetching category counts:', error));
      }
      updateCategoryCounts(); // Initial load

      // Fetch and display employer jobs
      function loadEmployerJobs() {
        fetch('/api/jobs/employer')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(jobs => {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = ''; // Clear loading message
            if (jobs.length === 0 || (jobs.message && jobs.message.includes('No jobs'))) {
              jobList.innerHTML = '<li class="collection-item">No jobs posted.</li>';
            } else {
              jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.innerHTML = `
                  <div class="job-details">
                    ${job.title} - ${job.category.name || 'Unknown'} - ${job.location} (${job.shiftDetails})
                  </div>
                  <div class="job-actions">
                    <a href="/job-edit?id=${job._id}" class="btn-small">Edit</a>
                    <button class="btn-small red delete-job" data-id="${job._id}">Delete</button>
                  </div>
                `;
                jobList.appendChild(li);
              });
              // Add delete event listeners
              document.querySelectorAll('.delete-job').forEach(button => {
                button.addEventListener('click', function() {
                  const jobId = this.getAttribute('data-id');
                  if (confirm('Are you sure you want to delete this job?')) {
                    fetch(`/api/jobs/${jobId}`, {
                      method: 'DELETE'
                    })
                      .then(response => {
                        if (response.ok) {
                          loadEmployerJobs(); // Reload jobs after deletion
                          M.toast({ html: 'Job deleted successfully!' });
                        } else {
                          throw new Error('Failed to delete job');
                        }
                      })
                      .catch(error => console.error('Error deleting job:', error));
                  }
                });
              });
            }
          })
          .catch(error => console.error('Error fetching jobs:', error));
      }
      loadEmployerJobs(); // Initial load

      // Handle form submission
      const form = document.querySelector('#jobForm');
      const card = document.querySelector('#jobFormCard');
      const successMsg = document.querySelector('#successMessage');
      if (!form || !card || !successMsg) console.error('Required elements not found');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Form data:', data);
        console.log('Sending fetch request to /api/jobs...');
        fetch('/api/jobs', {
          method: 'POST',
          body: new URLSearchParams(data),
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        })
          .then(response => {
            console.log('Fetch response status:', response.status);
            console.log('Response headers:', response.headers);
            if (response.status !== 201) {
              throw new Error(`Expected 201, got ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Success:', data);
            card.style.display = 'none';
            successMsg.style.display = 'block';
            successMsg.textContent = 'Job created successfully!';
            setTimeout(() => {
              card.style.display = 'block';
              successMsg.style.display = 'none';
              form.reset();
              M.updateTextFields();
              updateCategoryCounts(); // Refresh counts after submission
              loadEmployerJobs(); // Refresh job list after submission
            }, 3000);
          })
          .catch(error => console.error('Fetch error:', error));
        this.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => {
          this.querySelector('button[type="submit"]').disabled = false;
        }, 2000);
      });
    });
  </script>
</body>
</html> -->

<!--
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Job - Trial Shift</title>
  <link rel="stylesheet" href="/css/job-post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Post a New Job</h1>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobFormCard">
          <div class="card-content">
            <form action="/api/jobs" method="POST" class="col s12" id="jobForm">
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="title" name="title" required>
                  <label for="title">Job Title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <select id="category" name="category" required>
                    <option value="" disabled selected>Choose a category</option>
                    <option value="kitchenhand" data-count="0">Kitchen Hand <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="cleaning" data-count="0">Cleaning <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="delivery" data-count="0">Delivery <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="waiter" data-count="0">Waiter <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="barista" data-count="0">Barista <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="pickpacker" data-count="0">Pick Packer <span class="badge" data-badge-caption="">0 jobs</span></option>
                  </select>
                  <label for="category">Category</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="location" name="location" required>
                  <label for="location">Location</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="shiftDetails" name="shiftDetails" class="materialize-textarea" required></textarea>
                  <label for="shiftDetails">Shift Details</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <button type="submit" class="btn">Submit Job</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="successMessage" style="display: none; text-align: center; color: green;"></div>
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobManageCard">
          <div class="card-content">
            <h4>Your Posted Jobs</h4>
            <ul class="collection" id="jobList">
              <li class="collection-item">Loading jobs...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 center-align">
        <a href="/dashboard.html">Back to Dashboard</a>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and update category counts
      function updateCategoryCounts() {
        fetch('/api/categories/counts')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            console.log('Fetched category counts:', data);
            const select = document.getElementById('category');
            data.forEach(category => {
              const option = select.querySelector(`option[value="${category.name}"]`);
              if (option) {
                const badge = option.querySelector('.badge');
                if (badge) {
                  badge.textContent = ''; // Clear existing content
                  option.dataset.count = category.count;
                  badge.setAttribute('data-badge-caption', category.count > 0 ? `${category.count} jobs` : '');
                  console.log(`Updated ${category.name} to count: ${category.count}`);
                }
              }
            });
            M.FormSelect.init(select); // Reinitialize Materialize select
          })
          .catch(error => console.error('Error fetching category counts:', error));
      }
      updateCategoryCounts(); // Initial load

      // Fetch and display employer jobs
      function loadEmployerJobs() {
        fetch('/api/jobs/employer')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(jobs => {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = ''; // Clear loading message
            if (jobs.length === 0 || (jobs.message && jobs.message.includes('No jobs'))) {
              jobList.innerHTML = '<li class="collection-item">No jobs posted.</li>';
            } else {
              jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.innerHTML = `
                  <div class="job-details">
                    ${job.title} - ${job.category.name || 'Unknown'} - ${job.location} (${job.shiftDetails})
                  </div>
                  <div class="job-actions">
                    <a href="/job-edit?id=${job._id}" class="btn-small">Edit</a>
                    <button class="btn-small red delete-job" data-id="${job._id}">Delete</button>
                  </div>
                `;
                jobList.appendChild(li);
              });
              // Add delete event listeners
              document.querySelectorAll('.delete-job').forEach(button => {
                button.addEventListener('click', function() {
                  const jobId = this.getAttribute('data-id');
                  if (confirm('Are you sure you want to delete this job?')) {
                    fetch(`/api/jobs/${jobId}`, {
                      method: 'DELETE'
                    })
                      .then(response => {
                        if (response.ok) {
                          loadEmployerJobs(); // Reload jobs after deletion
                          M.toast({ html: 'Job deleted successfully!' });
                        } else {
                          throw new Error('Failed to delete job');
                        }
                      })
                      .catch(error => console.error('Error deleting job:', error));
                  }
                });
              });
            }
          })
          .catch(error => console.error('Error fetching jobs:', error));
      }
      loadEmployerJobs(); // Initial load

      // Handle form submission
      const form = document.querySelector('#jobForm');
      const card = document.querySelector('#jobFormCard');
      const successMsg = document.querySelector('#successMessage');
      if (!form || !card || !successMsg) console.error('Required elements not found');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Form data:', data);
        console.log('Sending fetch request to /api/jobs...');
        fetch('/api/jobs', {
          method: 'POST',
          body: new URLSearchParams(data),
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        })
          .then(response => {
            console.log('Fetch response status:', response.status);
            console.log('Response headers:', response.headers);
            if (response.status !== 201) {
              throw new Error(`Expected 201, got ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Success:', data);
            card.style.display = 'none';
            successMsg.style.display = 'block';
            successMsg.textContent = 'Job created successfully!';
            setTimeout(() => {
              card.style.display = 'block';
              successMsg.style.display = 'none';
              form.reset();
              M.updateTextFields();
              updateCategoryCounts(); // Refresh counts after submission
              loadEmployerJobs(); // Refresh job list after submission
            }, 3000);
          })
          .catch(error => console.error('Fetch error:', error));
        this.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => {
          this.querySelector('button[type="submit"]').disabled = false;
        }, 2000);
      });
    });
  </script>
</body>
</html> -->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post a Job - Trial Shift</title>
  <link rel="stylesheet" href="/css/job-post.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Post a New Job</h1>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobFormCard">
          <div class="card-content">
            <form action="/api/jobs" method="POST" class="col s12" id="jobForm">
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="title" name="title" required>
                  <label for="title">Job Title</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <select id="category" name="category" required>
                    <option value="" disabled selected>Choose a category</option>
                    <option value="kitchenhand" data-count="0">Kitchen Hand <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="cleaning" data-count="0">Cleaning <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="delivery" data-count="0">Delivery <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="waiter" data-count="0">Waiter <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="barista" data-count="0">Barista <span class="badge" data-badge-caption="">0 jobs</span></option>
                    <option value="pickpacker" data-count="0">Pick Packer <span class="badge" data-badge-caption="">0 jobs</span></option>
                  </select>
                  <label for="category">Category</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <input type="text" id="location" name="location" required>
                  <label for="location">Location</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <textarea id="shiftDetails" name="shiftDetails" class="materialize-textarea" required></textarea>
                  <label for="shiftDetails">Shift Details</label>
                </div>
              </div>
              <div class="row">
                <div class="input-field col s12">
                  <button type="submit" class="btn">Submit Job</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="successMessage" style="display: none; text-align: center; color: green;"></div>
      </div>
    </div>
    <div class="row">
      <div class="col s12">
        <div class="card" id="jobManageCard">
          <div class="card-content">
            <h4>Your Posted Jobs</h4>
            <ul class="collection" id="jobList">
              <li class="collection-item">Loading jobs...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col s12 center-align">
        <a href="/dashboard.html">Back to Dashboard</a>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch and update category counts
      function updateCategoryCounts() {
        fetch('/api/categories/counts')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            console.log('Fetched category counts:', data);
            const select = document.getElementById('category');
            data.forEach(category => {
              const option = select.querySelector(`option[value="${category.name}"]`);
              if (option) {
                const badge = option.querySelector('.badge');
                if (badge) {
                  badge.textContent = ''; // Clear existing content
                  option.dataset.count = category.count;
                  badge.setAttribute('data-badge-caption', category.count > 0 ? `${category.count} jobs` : '');
                  console.log(`Updated ${category.name} to count: ${category.count}`);
                }
              }
            });
            M.FormSelect.init(select); // Reinitialize Materialize select
          })
          .catch(error => console.error('Error fetching category counts:', error));
      }
      updateCategoryCounts(); // Initial load

      // Fetch and display employer jobs
      function loadEmployerJobs() {
        fetch('/api/jobs/employer')
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(jobs => {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = ''; // Clear loading message
            if (jobs.length === 0 || (jobs.message && jobs.message.includes('No jobs'))) {
              jobList.innerHTML = '<li class="collection-item">No jobs posted.</li>';
            } else {
              jobs.forEach(job => {
                const li = document.createElement('li');
                li.className = 'collection-item';
                li.innerHTML = `
                  <div class="job-details">
                    ${job.title} - ${job.category.name || 'Unknown'} - ${job.location} (${job.shiftDetails})
                  </div>
                  <div class="job-actions">
                    <a href="/job-edit?id=${job._id}" class="btn-small">Edit</a>
                    <button class="btn-small red delete-job" data-id="${job._id}">Delete</button>
                  </div>
                `;
                jobList.appendChild(li);
              });
              // Add delete event listeners
              document.querySelectorAll('.delete-job').forEach(button => {
                button.addEventListener('click', function() {
                  const jobId = this.getAttribute('data-id');
                  if (confirm('Are you sure you want to delete this job?')) {
                    fetch(`/api/jobs/${jobId}`, {
                      method: 'DELETE'
                    })
                      .then(response => {
                        if (response.ok) {
                          loadEmployerJobs(); // Reload jobs after deletion
                          M.toast({ html: 'Job deleted successfully!' });
                        } else {
                          throw new Error('Failed to delete job');
                        }
                      })
                      .catch(error => console.error('Error deleting job:', error));
                  }
                });
              });
            }
          })
          .catch(error => console.error('Error fetching jobs:', error));
      }
      loadEmployerJobs(); // Initial load

      // Handle form submission
      const form = document.querySelector('#jobForm');
      const card = document.querySelector('#jobFormCard');
      const successMsg = document.querySelector('#successMessage');
      if (!form || !card || !successMsg) console.error('Required elements not found');
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        console.log('Form data:', data);
        console.log('Sending fetch request to /api/jobs...');
        fetch('/api/jobs', {
          method: 'POST',
          body: new URLSearchParams(data),
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          }
        })
          .then(response => {
            console.log('Fetch response status:', response.status);
            console.log('Response headers:', response.headers);
            if (response.status !== 201) {
              throw new Error(`Expected 201, got ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('Success:', data);
            card.style.display = 'none';
            successMsg.style.display = 'block';
            successMsg.textContent = 'Job created successfully!';
            setTimeout(() => {
              card.style.display = 'block';
              successMsg.style.display = 'none';
              form.reset();
              M.updateTextFields();
              updateCategoryCounts(); // Refresh counts after submission
              loadEmployerJobs(); // Refresh job list after submission
            }, 3000);
          })
          .catch(error => console.error('Fetch error:', error));
        this.querySelector('button[type="submit"]').disabled = true;
        setTimeout(() => {
          this.querySelector('button[type="submit"]').disabled = false;
        }, 2000);
      });
    });
  </script>
</body>
</html> 